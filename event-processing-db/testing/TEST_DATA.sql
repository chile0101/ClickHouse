select * from user_profile_final_v;


select tenant_id,
       segment_id,
       length(users),
       at_final
from segment_users_final_v
where segment_id = '1jUWfJ2owtquABjbDWxQP6oxnkU';

select * from user_profile_final_v where anonymous_id = 'DCavCaog5eLSGFwi8f8mBes25iU';

['lastVisit','systems.mergeIdentifier','country','house_number','profile_image','acquisition_type','first_name','gender','device_os_version','last_name','firstVisit','dob','device_model','post_code','phone_number','loyalty_status','city','device_platform','id','registration_start_date','street','timezone','device_make','app_version','preferred_language','systems.lastUpdated','appversion','previousVisit','registrationstartdate','profileimage','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_0StartReached','systems.goals.1jUWfJ2owtquABjbDWxQP6oxnkU_0_0StartReached','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_0TargetReached','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_1StartReached','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_0_0StartReached','systems.goals.1jSO0zGZGoga6lX7vpqwBichCy5_0_0StartReached','systems.goals.1jS4Rbl6dkv36aXQfWQaVHLxd5H_0_0StartReached','systems.goals.1jPN77SZbyFj2aYoeirVxGGcKJD_1_0StartReached','systems.goals.1jRwUvE95fvIoguBMEgIC21OI65_0_0StartReached','systems.goals.1jRzsvB5oj86EWtgMe0OSzgLboZ_0_0StartReached','systems.goals.1jPKiEG8X2GZ3tIUH8WGEia38l0_1_0StartReached','systems.goals.1jP1RhZyXPnkRUsRGlfkUVAlLpD_0StartReached','systems.goals.1jSCYmsunY8PnDfEjd6iWP4fF5f_0_0StartReached','systems.goals.1jPKiEG8X2GZ3tIUH8WGEia38l0_0_0StartReached','systems.goals.1jRwUvE95fvIoguBMEgIC21OI65_0_0TargetReached','systems.goals.1jRwUvE95fvIoguBMEgIC21OI65_0_1StartReached','systems.goals.1jS6vp4IciwMvx2CucEwEAV07ZN_0_0StartReached','systems.goals.1jSO0zGZGoga6lX7vpqwBichCy5_0_0TargetReached','systems.goals.1jVMk40iodyvOukinjcN9BeSSSk_0_0StartReached','systems.goals.1jVMk40iodyvOukinjcN9BeSSSk_0_0TargetReached']
['Gold','2020-10-28T07:07:09Z','Yazman','Female','3.87','MyY8pXr','Nguyen','3.3.1','05/11/2019','2020-10-28T05:06:44Z','https://robohash.org/rationeconsequaturaut.jpg?size=100x100&set=set1','04/02/1987','180 848 3248','Mercedes-Benz','CLK-Class','711','6.91','https://robohash.org/enimvoluptascumque.jpg?size=100x100&set=set1','Asia/Karachi','Italian','2020-10-28T07:30:21Z','iOS','63210','paid-google','Hovde','Truong','Pakistan','27/05/2018','711','2020-10-28T07:30:28Z','2020-10-28T07:30:28Z','2020-10-28T07:07:20Z','2020-10-28T07:07:20Z','2020-10-28T07:07:20Z','2020-10-28T07:07:20Z','2020-10-28T07:07:20Z','2020-10-28T06:19:45Z','2020-10-28T07:07:20Z','2020-10-28T06:19:46Z','2020-10-28T07:07:39Z','2020-10-28T07:07:28Z','2020-10-28T06:19:45Z','2020-10-28T07:30:36Z','2020-10-28T07:07:39Z','2020-10-28T06:19:46Z','2020-10-28T07:07:28Z','2020-10-28T07:30:29Z']



select * from segment_users_final_v where segment_id = '1jVgRUc7cIsyIsRs0gzXkWhl15U';

['DCbdEWyMPMmvmPBRsxPyeyblyeY','DCfVprcIjzTWwL9BfvvXF9Bgwwr','DCbZpjfgl1M1igiD7IWHbwjbg9C','DCfS5rkz69A9ATrv9Cls6eo9AX2','DCbm2cKvc9Ax9Co9CJzGTbMLmVW','DCfWhtg6P4zGLOoeHhG9Bz0TiX9','DCbrNXHKI6c9BJZrwtL7HZMuY8T','DCaWSdoCe9C5OYJA9C3YxE9ATdq','DCfT4uhTe3hIkQ9BrWRh9CxAz9C','DCacMS6k5N9Axf9AyAQifxjapVu','DCbY3eQhFeLH1WIXVx9CblGjvwI','DCbj9A549CrAXOAQFy1CddwBtu0','DCfTLR3pdhKexTZCONXXmtkZTGo','DCfYIYT0vc6tbYfFrIHq73QjIys','DCbXv7bDNPr3HyJWhSdLAJARpsU','DCfXEMCXPcltQwrehYfXNWvp9Cy','DCabjUBudDi9Ch4kSlVkMOPzxzZ','DCfVAKq9AX44Hd9AxDtNLOAtKxJ','DCbY8ID9BNbYqQYyvMPymwYVWgS','DCabPSJEeFlinQZT3loUq8Kxfcw','DCaWiLROrSdvxf7ttupkZk4iVow','DCbtN8FPRvkJSz9A3u9Cw4jG9BL','DCbd79C0KYtJ5OqijSo9BivnROY','DCaV0blW9Ad3MrZIGpXhn9BgoBa','DCbgz2r2NWugXuqdvvDhiEPXugU','DCfUCPSgKiCMjaUrfvFFcWd9Cw9','DCbTTDM5Zv7dccviBj8e2YiC2No','DCbjwJblJHYrhWyeUmuNQ7Egazc','DCaWC0Iz8BRfuSF01hQz1WAc6V0','DCbaYYNw64qxqWS7sO8yeWY1u9C','DCbjDEMrukaZaLkqlbRxxfsPHFE','DCaXY0xq1HKtyAODksamfzYTYZ0','DCaWsBEPCtHSJ4SRJt29Ca49C6O','DCfYc711AkC9C7KXZfQ2pPPdMKg','DCaYfyTYq1szaEpqCbrclBVfaM8','DCaXw0xm2AiXhTM3Wnfnh9B9B4v','DCfW8OtQgiWRp4uZDgSlmZ7fzJk','DCbU79AyH75nI9B5bc0XsliWcLx','DCfSd5dLOqlW628tK5XG44Saxw0','DCbr2BWGen5ZgVm9AHEsNhk9CAC','DCfW0hkkuCDktorK1KI1Ef6lukw','DCaY53YML9CNY9BU6clj9BynC9B','DCfWYE2AG9AMCWFSkIcbaGMhevG','DCfX4E9CxVAXavyZYeUvkYi4nwK','DCfVr2wnq8DY9ABLdONMHg9BZn9','DCaXIn2Db06KCaiESBBgeKctw0M','DCfRt4Bgh2hlre871kJ8uDY67kI','DCaggWXnSPvtrVFLX5W8YgJa1H0','DCbvV7xnh2MyKYpa7fCXX3IYinA','DCbiK1oBKkTuSGjcAvuQk9CpKX0','DCaU5JOQ9BDJOUujgAOASoJFQmm','DCfXOUfMx2FpeTBV8Xvuu19BhKi','DCabH8bOo1urUolyRg6nHl13GSs','DCfZkPv8pymhOAeA3hVMLdswqq0','DCacHLtTzT6RFMs3oL8r1ogya8c','DCfZaTuYDaTZayQN5ILP13MQG3c','DCa9Cjn9ABJWLQ20euHYheRjfwf','DCfYxrpsvBWrCcLzuW9Br2lFXUU','DCfS0nNyZHMkgQ9CMEI39CVqj0W','DCabedFltQutV7gO3T6DTJ79BFn','DCbsKeXweBQLadsVqKI9AoQrelg','DCbrIYuDEt2aep8T9BTRmYO364Q','DCbgVSnTNieXrenGQ9BXm6xnv3U','DCbbAZ01OW9A0pmI03KV9A7jnYf','DCbkF4lJOghuMvE9BySE9Cb9B0i','DCabM9CsYtZiF9AaitiGjb2tC89','DCfV1tPgmDnA7A5AevbGBIo6bFM','DCabv9BBTQB10gvlplj3sr9A51p','DCfXx4JK0fOg1ybITX1Mly4G0vM','DCaXjIYXSioANinH0bwY8rLD9CG','DCfXVXK8W6z8ype9C9BFatGAxkS','DCaWuznKGOFydAavPEM5j6t5arE','DCboojx8F7WgkeyvA2J6hg4aLt8','DCfUSUDoN9BubO6L269AlJ2Iwzg','DCaYc6AgpvSyRvoJenev08WpNsc','DCbmQQ9BMPR9Ap9AFP5e9CnvDdn','DCbmfVAizyeO57T9B655yJuQcSG','DCfZQsQ9AhKKbl5RKZHZViS3sjf','DCfYDUIQJ7fgZa4bxBaKwpAoxgU','DCfSbbBCphwc1lj1HjzaI5oHlDk','DCfThPvadiomZNaCMhcMb85HJUs','DCbYx3VYkkmwDnpQJPdZCA9B8Gj','DCaXThPbjUvXIiUfs1era4QpvZY','DCfVd1NEHKKjuXoEyzuqqfxDZdM','DCaXbhL1AkKyiaUzmfxSZq69CHZ','DCfZA5AwX0Zu9CiJML9CYMgKMpU','DCbX3TCCLROgQ6fsvW4fTbRi6pg','DCfZYLYEJRuUItYk35CFe5Xyxys','DCfTbshAGb7Day1ahUAn2y2GChg','DCaWFX9AzYbuJFJYYI4QOVPKEHC','DCaWNDvxbUOm9ArVDhXAzr0nKB4','DCfZF2cXr2a69Cvf0kqJeaWhQeh','DCaXtsp9C85pqABnn6aEWe7A7Hy','DCaTl9AfUtJxOAq6o1tZCMubFTj','DCfVCkcSjKtcfwvvm9CekirU9C6','DCaTYiFr9BK6dldV3LfQBCdmTkO','DCbbqvMfmTMFjhyFkvLw2wCAHrk','DCbjaP9CPPZ4ZJzMn9BCvBRN1aq','DCfYNb9Cwjbg2Sq6FVaBdn9CU6k','DCbbtI9AOt9CDoIEGXeABtDA0rZ','DCbgS3gxp46nZvswAOkYxE471Qc']

select * from user_profile_final_v where anonymous_id = 'DCbdEWyMPMmvmPBRsxPyeyblyeY';

['lastVisit','systems.mergeIdentifier','device_make','profileimage','last_name','gender','registrationstartdate','device_os_version','appversion','country','loyalty_status','device_model','dob','street','device_platform','id','city','timezone','first_name','preferred_language','house_number','firstVisit','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_0StartReached','systems.goals.1jUWfJ2owtquABjbDWxQP6oxnkU_0_0StartReached','systems.lastUpdated','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_0TargetReached','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_1_1StartReached','systems.goals.1jPFD35Kw29c0uBl9JttH9ofXhp_0_0StartReached','systems.goals.1jPKiEG8X2GZ3tIUH8WGEia38l0_0_0StartReached','systems.goals.1jSO0zGZGoga6lX7vpqwBichCy5_0_0StartReached','systems.goals.1jSO0zGZGoga6lX7vpqwBichCy5_0_0TargetReached','previousVisit','systems.goals.1jVMk40iodyvOukinjcN9BeSSSk_0_0StartReached','systems.goals.1jVgRUc7cIsyIsRs0gzXkWhl15U_0_0StartReached','systems.goals.1jVgRUc7cIsyIsRs0gzXkWhl15U_0_0TargetReached']






anonymous revenue total_order
a1     1
a1     2
a2     3
a3     4

-- Total revenue

-- Total revenue per user


select * from segment_users_final_v where segment_id = '1jXJ48BRyqzJ0EW4toUGrfumSZ2';




SELECT
    count() as total_user_have_conversion
FROM
(
 SELECT tenant_id, users
 FROM
 (
    SELECT
        tenant_id,
        argMaxMerge(users) as users
    FROM segment_users_final
    WHERE (tenant_id = 1) AND (segment_id = '1jP08tvZXG9vJj7uJ4okEwCCLlE')
    GROUP BY
        tenant_id,
        segment_id
 ) ARRAY JOIN users
)  as sf
JOIN
(
SELECT
    tenant_id,
    anonymous_id,
    arrayExists(key -> key == 'revenue', num_keys) as is_conversion
FROM
    (
        SELECT
            tenant_id,
            anonymous_id,
            argMaxMerge(num_properties.keys) AS num_keys
        FROM user_profile_final
        WHERE tenant_id = 1
        GROUP BY
            tenant_id,
            anonymous_id
    )
    WHERE is_conversion != 0
) as pf
ON sf.tenant_id = pf.tenant_id and sf.users =pf.anonymous_id
;




SELECT
    tenant_id,
    anonymous_id,
    arrayExists(key -> key == 'revenue', num_keys) as is_conversion
FROM
(
    SELECT
        tenant_id,
        anonymous_id,
        argMaxMerge(num_properties.keys) AS num_keys
    FROM user_profile_final
    WHERE tenant_id = 1
    GROUP BY
        tenant_id,
        anonymous_id
)
WHERE is_conversion != 0
;


select * from user_profile_final_v;












SELECT
    keys[n] AS key,
    values[n] AS value
FROM
(
    SELECT
        ['{MAX}', '{AVG}', '{MED}', '{MIN}'] AS keys,
        [maxOrDefault(v), avgOrDefault(v), medianOrDefault(v), minOrDefault(v)] AS values
    FROM
    (
        SELECT
            tenant_id,
            segment_id,
            users
        FROM
        (
            SELECT
                tenant_id,
                segment_id,
                argMaxMerge(users) AS users
            FROM segment_users_final
            WHERE tenant_id = 1 AND segment_id = '1jP08tvZXG9vJj7uJ4okEwCCLlE'
            GROUP BY
                tenant_id,
                segment_id
        )
        ARRAY JOIN users
    ) AS sf
    INNER JOIN
    (
        SELECT
            tenant_id,
            anonymous_id,
            arrayExists(key -> key == 'revenue', num_keys) as have_conversion,
            num_vals[indexOf(num_keys, 'revenue')] AS v
        FROM
        (
            SELECT
                tenant_id,
                anonymous_id,
                argMaxMerge(num_properties.keys) AS num_keys,
                argMaxMerge(num_properties.vals) AS num_vals
            FROM user_profile_final
            WHERE tenant_id = 1
            GROUP BY
                     tenant_id,
                     anonymous_id
        )
        WHERE have_conversion != 0
    ) AS pf ON (sf.tenant_id = pf.tenant_id) AND (sf.users = pf.anonymous_id)
    WHERE v >= 0
) ARRAY JOIN arrayEnumerate(keys) as n;





SELECT
    tenant_id,
    anonymous_id,
    arrayExists(key -> key == 'revenue', num_keys) as is_conversion,
    num_vals[indexOf(num_keys, 'revenue')] AS v
FROM
(
    SELECT
        tenant_id,
        anonymous_id,
        argMaxMerge(num_properties.keys) AS num_keys,
        argMaxMerge(num_properties.vals) AS num_vals
    FROM user_profile_final
    WHERE tenant_id = 1
    GROUP BY
             tenant_id,
             anonymous_id
)
WHERE is_conversion != 0;